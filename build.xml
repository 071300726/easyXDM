<?xml version="1.0" encoding="UTF-8"?>
<project name="easyXSS" default="build" basedir=".">
	<property file="build.properties"/>
	
	<!-- Setup classpath for js-build-tools ant tasks -->
	<path id="js-build-tasks.classpath">
		<pathelement location="."/>
		<fileset dir="tools\js-build-tools\lib">
			<include name="**/*.jar"/>
		</fileset>
	</path>
	
	<taskdef name="preprocess" classname="com.moxiecode.ant.tasks.PreProcessTask" classpathref="js-build-tasks.classpath" loaderref="js-build-tasks.classpath.loader" />
	<taskdef name="yuicompress" classname="com.moxiecode.ant.tasks.YuiCompressTask" classpathref="js-build-tasks.classpath" loaderref="js-build-tasks.classpath.loader" />
		
	<target name="clean" depends="" description="Cleans up the project from temporary files">
		<delete dir="${project.build.dir}" quiet="true"/>
    </target>
	
	<target name="build" depends="clean">
		<buildnumber/>
		<mkdir dir="${project.build.dir}"/>
		<mkdir dir="${project.build.dir}\temp"/>
		
		<concat destfile="${project.build.dir}\temp\easyXSS.combined.js">	
            <fileset dir="." includes="${project.src.dir}\easyXSS.js" />
            <fileset dir="." includes="${project.src.dir}\easyXSS.Exceptions.js" />
            <fileset dir="." includes="${project.src.dir}\easyXSS.DomHelper.js" />
			<fileset dir="." includes="${project.src.dir}\easyXSS.Events.js" />
			<fileset dir="." includes="${project.src.dir}\easyXSS.Transport.js" />
			<fileset dir="." includes="${project.src.dir}\easyXSS.Configuration.js" />
			<fileset dir="." includes="${project.src.dir}\easyXSS.Url.js" />
			<fileset dir="." includes="${project.src.dir}\easyXSS.Serializing.js" />
        </concat>
	
		<replace file="${project.build.dir}\temp\easyXSS.combined.js"
			token="%%version%%" value="1.3.0.${build.number}"/>

		<!-- Run jslint -->
		<java jar="tools\jslint4java-1.3.1\jslint4java-1.3.1.jar" fork="true" failonerror="true" maxmemory="128m" >
			<arg value="${project.build.dir}\temp\easyXSS.combined.js"/>
        </java>
		
		<!-- Process pre proccesing instuctions like #if/#endif etc -->
		<preprocess infile="${project.build.dir}\temp\easyXSS.combined.js" outfile="${project.build.dir}\temp\easyXSS.js"/>
		<preprocess infile="${project.build.dir}\temp\easyXSS.combined.js" outfile="${project.build.dir}\temp\easyXSS.debug.js" defines="debug"/>
	    <preprocess infile="${project.src.dir}\hash.html" outfile="${project.build.dir}\temp\hash.html"/>
		
		<delete file="${project.build.dir}\temp\easyXSS.combined.js" quiet="true"/>

		<!-- Compress the file using the YUI Compressor -->
		<yuicompress infile="${project.build.dir}\temp\easyXSS.js" outfile="${project.build.dir}\temp\easyXSS.min.js" />
		
		<!-- concat header files -->
		<concat destfile="${project.build.dir}\easyXSS.js">
            <fileset dir="." includes="${project.src.dir}\header.js" />
            <fileset dir="." includes="${project.build.dir}\temp\easyXSS.js" />
		</concat>
		<concat destfile="${project.build.dir}\easyXSS.debug.js">
            <fileset dir="." includes="${project.src.dir}\header.js" />
            <fileset dir="." includes="${project.build.dir}\temp\easyXSS.debug.js" />
		</concat>
		<concat destfile="${project.build.dir}\easyXSS.min.js">
            <fileset dir="." includes="${project.src.dir}\header.js" />
            <fileset dir="." includes="${project.build.dir}\temp\easyXSS.min.js" />
		</concat>
		<concat destfile="${project.build.dir}\hash.html">
            <fileset dir="." includes="${project.src.dir}\header.html" />
            <fileset dir="." includes="${project.build.dir}\temp\hash.html" />
		</concat>
		
		<copy todir="${project.build.dir}">
			<fileset dir="${project.build.dir}\temp"/>
			<fileset file= "${project.src.dir}\changes.txt"/>
			<fileset file= "tools\json2.js"/>
		</copy>
		
		<copy todir="${project.build.dir}\example">
			<fileset dir="${project.src.dir}\example"/>
		</copy>
		<delete dir="${project.build.dir}\temp" quiet="true"/>
	</target>
	
	<target name="document" depends="build">
		<java jar="tools\ext-doc-1.0.131\ext-doc.jar" fork="true" failonerror="true" maxmemory="128m" >
			<arg line="-p docs.xml -o docs -t tools\ext-doc-1.0.131\template\ext\template.xml"/>
        </java>
	</target>
	
	<target name="package" depends="document">
		<mkdir dir="dist"/>
		<zip destfile="dist\${ant.project.name}.zip" basedir="${project.build.dir}"/>
	</target>
</project>
