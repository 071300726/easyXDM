<!doctype html>
<html>
    <head>
        <title>easyXDM cross-domain XHMLHttpRequest provider</title>
        <script type="text/javascript" src="easyXDM.debug.js">
            // This should be changed so that it points to the minified version before use in production.
        </script>
        <script type="text/javascript">
            // Update to point to your copy
            easyXDM.DomHelper.requiresJSON("json2.js");
        </script>
        <script type="text/javascript">
        var tinylib = (function(){
            // From http://peter.michaux.ca/articles/feature-detection-state-of-the-art-browser-scripting
            function isHostMethod(object, property){
                var t = typeof object[property];
                return t == 'function' ||
                (!!(t == 'object' && object[property])) ||
                t == 'unknown';
            }
            
            /**
             * Creates a cross-browser XMLHttpRequest object
             * @return {XMLHttpRequest} A XMLHttpRequest object.
             */
            var getXhr = (function(){
                if (isHostMethod(window, "XMLHttpRequest")) {
                    return function(){
                        return new XMLHttpRequest();
                    };
                }
                else {
                    var item = (function(){
                        var list = ["Microsoft", "Msxml2", "Msxml3"], i = list.length;
                        while (i--) {
                            try {
                                item = list[i] + ".XMLHTTP";
                                var obj = new ActiveXObject(item);
                                return item;
                            } 
                            catch (e) {
                            }
                        }
                    }());
                    return function(){
                        return new ActiveXObject(item);
                    };
                }
            }());
            
            /** 
             * Runs an asynchronous request using XMLHttpRequest
             * @param {object} config The configuration
             */
            function ajax(config){
                var req = getXhr(), pairs = [], data, isPOST;
                
                easyXDM.apply(config, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-Requested-With": "XMLHttpRequest"
                    },
                    success: Function.prototype,
                    error: function(msg){
                        throw new Error(msg);
                    },
                    data: {},
                    type: "plain"
                }, true);
                isPOST = config.method == "POST";
                
                for (var key in config.data) {
                    if (config.data.hasOwnProperty(key)) {
                        pairs.push(encodeURIComponent(key) + "=" + encodeURIComponent(config.data[key]));
                    }
                }
                data = pairs.join("&");
                
                req.open(config.method, config.url + (isPOST ? "" : "?" + data), true);
                
                for (var prop in config.headers) {
                    if (config.headers.hasOwnProperty(prop)) {
                        req.setRequestHeader(prop, config.headers[prop]);
                    }
                }
                
                req.onreadystatechange = function(){
                    if (req.readyState == 4) {
                        var response, errorMsg;
                        if (config.type == "json") {
                            try {
                                response = req.responseText;
                                response = easyXDM.getJSONObject().parse(response);
                            } 
                            catch (e) {
                                errorMsg = "An error occured while parsing the JSON: " + e.message;
                            }
                        }
                        else {
                            response = req.responseText;
                        }
                        
                        if (req.status < 200 || req.status >= 300) {
                            errorMsg = "The server did not return a valid status code.";
                        }
                        
                        if (errorMsg) {
                            config.error({
                                message: errorMsg,
                                status: req.status,
                                data: response,
                                toString: function(){
                                    return this.message + " Status: " + this.status;
                                }
                            });
                        }
                        else {
                            config.success(response);
                        }
                        
                        req.onreadystatechange = Function.prototype;
                        req = null;
                    }
                };
                
                req.send(isPOST ? data : "");
            }
            return {
                /** 
                 * Runs an asynchronous request using XMLHttpRequest
                 * @param {object} config This object can have the following properties
                 * <ul>
                 * <li> url: string<br/>The url to request.</li>
                 * <li> method: string<br/>POST, HEAD or GET.</li>
                 * <li> data: object<br/>Any data that should be sent.</li>
                 * <li> type: string<br/>The type of data to retrieve. If set to 'json' then the result will be parsed.</li>
                 * <li> success: function<br/>The callback function for successfull requests.</li>
                 * <li> error: function<br/>The callback function for errors.</li>
                 * </ul>
                 */
                ajax: ajax,
            };
        })();
        
        var remote = new easyXDM.Rpc({
            local: "name.html"
        }, {
            local: {
                post: function(url, data, success, error){
                    tinylib.ajax({
                        url: url,
                        method: "POST",
                        data: data,
                        type: "json",
                        success: success,
                        error: error
                    });
                }
            }
        });
        </script>
    </head>
    <body>
    </body>
</html>
